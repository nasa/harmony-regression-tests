# This workflow runs HOSS regression test suite, using the tag from the workflow call.
#
# Required settings in the repository:
# Environments (exactly the following strings):
# - production
# - uat
# - sit
#
# Secrets in each environment:
# - EDL_USER
# - EDL_PASSWORD
#
# Variables in each environment:
# - HARMONY_HOST_URL
#
# Note: A workflow_call event can only have inputs of type boolean, number or
# string.
name: Run HOSS test suite

on:
  workflow_call:
    inputs:
      docker-image-tag:
        required: false
        type: string
        default: 'latest'
      harmony-environment:
        required: true
        type: string

  repository_dispatch:
    types: [hoss]
    inputs:
      docker-image-tag:
        required: false
        type: string
        default: 'latest'
      harmony-environment:
        required: true
        type: choice
        options:
          - sit
          - uat
          - production

jobs:
  hoss_job:
    environment: ${{ github.event.client_payload.harmony-environment }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Pull Docker image
        run: docker pull ghcr.io/nasa/regression-tests-hoss:${{ github.event.client_payload.docker-image-tag }}

      - name: Set HARMONY_HOST_URL
        run: |
          if [ "${{ github.event.client_payload.harmony-environment }}" == "uat" ]; then
            echo "HARMONY_HOST_URL=https://harmony.uat.earthdata.nasa.gov"
            echo "HARMONY_HOST_URL=https://harmony.uat.earthdata.nasa.gov" >> $GITHUB_ENV
          elif [ "${{ github.event.client_payload.harmony-environment }}" == "production" ]; then
            echo "HARMONY_HOST_URL=https://harmony.earthdata.nasa.gov"
            echo "HARMONY_HOST_URL=https://harmony.earthdata.nasa.gov" >> $GITHUB_ENV
          else
            echo "HARMONY_HOST_URL=https://harmony.sit.earthdata.nasa.gov"
            echo "HARMONY_HOST_URL=https://harmony.sit.earthdata.nasa.gov" >> $GITHUB_ENV
          fi

      - name: Execute notebook
        working-directory: ./test
        env:
          EDL_USER: ${{ secrets.EDL_USER }}
          EDL_PASSWORD: ${{ secrets.EDL_PASSWORD }}
          HARMONY_HOST_URL: ${{ env.HARMONY_HOST_URL }}
        run: ./run_notebooks.sh hoss

      - name: Save notebook as an artefact
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: notebook-output
          path: test/output/hoss/Results.ipynb
