# This workflow runs variable-subsetter regression test suite, using the tag from the workflow call.
#
# Required settings in the repository:
# Environments (exactly the following strings):
# - prod
# - uat
# - sit
#
# Secrets in each environment:
# - EDL_USER
# - EDL_PASSWORD
#
# Variables in each environment:
# - HARMONY_HOST_URL
#
# Note: A workflow_call event can only have inputs of type boolean, number or
# string.
name: Run variable-subsetter test suite

on:
  workflow_call:
    inputs:
      harmony-environment:
        required: true
        type: string
      docker-image-tag:
        required: false
        type: string
        default: 'latest'

  repository_dispatch:
    types: [harmony-service-example]
    inputs:
      harmony-environment:
        required: true
        type: choice
        options:
          - sit
          - uat
          - prod
      docker-image-tag:
        required: false
        type: string
        default: 'latest'

jobs:
  variable_subsetter_job:
    environment: ${{ github.event.client_payload.harmony-environment }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get the URL of the current workflow run
        run: echo "RUN_URL=${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> $GITHUB_ENV

      - name: Pull Docker image
        run: docker pull ghcr.io/nasa/regression-tests-variable-subsetter:${{ github.event.client_payload.docker-image-tag || 'latest' }}

      - name: Set HARMONY_HOST_URL
        run: |
          if [ "${{ github.event.client_payload.harmony-environment }}" == "uat" ]; then
            echo "HARMONY_HOST_URL=https://harmony.uat.earthdata.nasa.gov"
            echo "HARMONY_HOST_URL=https://harmony.uat.earthdata.nasa.gov" >> $GITHUB_ENV
          elif [ "${{ github.event.client_payload.harmony-environment }}" == "prod" ]; then
            echo "HARMONY_HOST_URL=https://harmony.earthdata.nasa.gov"
            echo "HARMONY_HOST_URL=https://harmony.earthdata.nasa.gov" >> $GITHUB_ENV
          else
            echo "HARMONY_HOST_URL=https://harmony.sit.earthdata.nasa.gov"
            echo "HARMONY_HOST_URL=https://harmony.sit.earthdata.nasa.gov" >> $GITHUB_ENV
          fi

      - name: Execute notebook
        id: test-step
        working-directory: ./test
        env:
          EDL_USER: ${{ secrets.EDL_USER }}
          EDL_PASSWORD: ${{ secrets.EDL_PASSWORD }}
          HARMONY_HOST_URL: ${{ env.HARMONY_HOST_URL }}
        run: ./run_notebooks.sh variable-subsetter

      - name: Save notebook as an artifact
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: notebook-output
          path: test/output/variable-subsetter/Results.ipynb

      - name: Send mail
        if: always()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.SMTP_USER }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: variable-subsetter regression test result is ${{ steps.test-step.outcome }}
          to: ${{ vars.TO_EMAIL_VARIABLE_SUBSETTER }}
          from: ${{ secrets.FROM_EMAIL }}
          body: variable-subsetter regression test result is ${{ steps.test-step.outcome }}! View the details at ${{ env.RUN_URL }}.
