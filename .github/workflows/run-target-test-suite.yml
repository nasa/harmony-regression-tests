# This workflow runs a specific regression test suite, using the input image
# name and tag from the workflow call.
#
# Required settings in the repository:
# Environments (exactly the following strings):
# - production
# - uat
# - sit
#
# Secrets in each environment:
# - EDL_USER
# - EDL_PASSWORD
#
# Variables in each environment:
# - HARMONY_HOST_URL
#
name: Run test suite

on:
  workflow_call:
    inputs:
      docker-image-name:
        required: true
        type: choice
        options:
          - geoloco
          - harmony-regression
          - harmony
          - hga
          - hoss
          - hybig
          # - n2z  # Commented out because needs AWS credentials
          - regridder
          - swath-projector
          - trajectory-subsetter
          - variable-subsetter
      docker-image-tag:
        required: false
        type: string
        default: 'latest'
      harmony-environment:
        required: true
        type: choice
        options:
          - sit
          - uat
          - production

jobs:
  run-tests:
    environment: ${{ inputs.harmony-environment }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Pull Docker image 
        run: docker pull ghcr.io/nasa/${{ inputs.docker-image-name }}:${{ inputs.docker-image-tag }}
      - name: Set environment variables
        run: |
          export EDL_USER=${{ secrets.EDL_USER }}
          export EDL_PASSWORD=${{ secrets.EDL_PASSWORD }}
          export HARMONY_HOST_URL=${{ env.HARMONY_HOST_URL }}
      - name: Execute notebook
        working-directory: test
        run: ./run-notebook.sh ${{ inputs.docker-image-name }}
      - name: Save notebook as an artefact
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: notebook-output
          path: test/output/${{ inputs.docker-image-name }}/Results.ipynb
